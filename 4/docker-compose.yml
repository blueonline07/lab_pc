services:
  mpi-head:
    build:
      context: .
      dockerfile: Dockerfile
    hostname: mpi-head
    container_name: mpi-head
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - mpi-network
    command: >
      sh -c "
        /usr/sbin/sshd &&
        tail -f /dev/null
      "
    environment:
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - OMPI_MCA_btl_vader_single_copy_mechanism=none
    ports:
      - "2220:22"

  mpi-node-1:
    build:
      context: .
      dockerfile: Dockerfile
    hostname: mpi-node-1
    container_name: mpi-node-1
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - mpi-network
    command: >
      sh -c "
        /usr/sbin/sshd &&
        tail -f /dev/null
      "
    environment:
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - OMPI_MCA_btl_vader_single_copy_mechanism=none
    ports:
      - "2221:22"

  mpi-node-2:
    build:
      context: .
      dockerfile: Dockerfile
    hostname: mpi-node-2
    container_name: mpi-node-2
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - mpi-network
    command: >
      sh -c "
        /usr/sbin/sshd &&
        tail -f /dev/null
      "
    environment:
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - OMPI_MCA_btl_vader_single_copy_mechanism=none
    ports:
      - "2222:22"

  mpi-node-3:
    build:
      context: .
      dockerfile: Dockerfile
    hostname: mpi-node-3
    container_name: mpi-node-3
    volumes:
      - .:/workspace
    working_dir: /workspace
    networks:
      - mpi-network
    command: >
      sh -c "
        /usr/sbin/sshd &&
        tail -f /dev/null
      "
    environment:
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - OMPI_MCA_btl_vader_single_copy_mechanism=none
    ports:
      - "2223:22"

networks:
  mpi-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

